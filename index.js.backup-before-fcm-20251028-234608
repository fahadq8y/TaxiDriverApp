/**
 * @format
 */

import { AppRegistry } from 'react-native';
import App from './App';
import { name as appName } from './app.json';
import BackgroundGeolocation from 'react-native-background-geolocation';
import firestore from '@react-native-firebase/firestore';

// Register main app component
AppRegistry.registerComponent(appName, () => App);

// Calculate distance between two coordinates in meters (Haversine formula)
const calculateDistance = (lat1, lon1, lat2, lon2) => {
  const R = 6371e3; // Earth radius in meters
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c; // Distance in meters
};

// Check if we should save this location to history (using AsyncStorage for persistence)
const shouldSaveToHistory = async (location) => {
  const AsyncStorage = require('@react-native-async-storage/async-storage').default;
  const now = Date.now();
  const currentLat = location.coords.latitude;
  const currentLng = location.coords.longitude;
  
  try {
    // Read last save time and location from AsyncStorage
    const lastTimeStr = await AsyncStorage.getItem('lastHistorySaveTime');
    const lastLocationStr = await AsyncStorage.getItem('lastHistorySaveLocation');
    
    // Save if it's the first location
    if (!lastTimeStr || !lastLocationStr) {
      console.log('[shouldSaveToHistory] First location - will save');
      return true;
    }
    
    const lastHistorySaveTime = parseInt(lastTimeStr, 10);
    const lastHistorySaveLocation = JSON.parse(lastLocationStr);
    
    // Save if 1 minute has passed
    const timeDiff = now - lastHistorySaveTime;
    if (timeDiff >= 60000) { // 60 seconds
      console.log(`[shouldSaveToHistory] Time threshold met: ${Math.round(timeDiff/1000)}s - will save`);
      return true;
    }
    
    // Save if moved more than 50 meters
    const lastLat = lastHistorySaveLocation.latitude;
    const lastLng = lastHistorySaveLocation.longitude;
    const distance = calculateDistance(lastLat, lastLng, currentLat, currentLng);
    if (distance >= 50) { // 50 meters
      console.log(`[shouldSaveToHistory] Distance threshold met: ${Math.round(distance)}m - will save`);
      return true;
    }
    
    console.log(`[shouldSaveToHistory] Thresholds not met (${Math.round(timeDiff/1000)}s, ${Math.round(distance)}m) - skip`);
    return false;
    
  } catch (error) {
    console.error('[shouldSaveToHistory] Error:', error);
    // In case of error, save to be safe
    return true;
  }
};

// Register Headless Task for background tracking when app is terminated
const HeadlessTask = async (event) => {
  const { name, params } = event;
  
  console.log('[HeadlessTask] Event received:', name);
  
  if (name === 'location') {
    const location = params;
    console.log('[HeadlessTask] Location received:', location.coords);
    
    try {
      // Get driver ID from storage
      const AsyncStorage = require('@react-native-async-storage/async-storage').default;
      const driverId = await AsyncStorage.getItem('employeeNumber');
      
      if (!driverId) {
        console.warn('[HeadlessTask] No driver ID found, skipping location save');
        return;
      }
      
      console.log('[HeadlessTask] Saving location for driver:', driverId);
      
      // Save to drivers collection (current location)
      await firestore()
        .collection('drivers')
        .doc(driverId)
        .set({
          location: {
            latitude: location.coords.latitude,
            longitude: location.coords.longitude,
            accuracy: location.coords.accuracy,
            speed: location.coords.speed || 0,
            heading: location.coords.heading || 0,
          },
          lastUpdate: new Date(),
          isActive: true,
        }, { merge: true });
      
      console.log('[HeadlessTask] Location saved successfully to drivers collection');
      
      // Save to locationHistory if conditions are met
      if (await shouldSaveToHistory(location)) {
        try {
          // Calculate expiry date (2 months from now)
          const expiryDate = new Date();
          expiryDate.setMonth(expiryDate.getMonth() + 2);
          
          await firestore()
            .collection('locationHistory')
            .add({
              driverId: driverId,
              latitude: location.coords.latitude,
              longitude: location.coords.longitude,
              accuracy: location.coords.accuracy || 0,
              speed: location.coords.speed || 0,
              heading: location.coords.heading || 0,
              timestamp: new Date(),
              expiryDate: expiryDate,
              appState: 'background',
              userId: driverId,
            });
          
          // Update last save time and location in AsyncStorage
          await AsyncStorage.setItem('lastHistorySaveTime', Date.now().toString());
          await AsyncStorage.setItem('lastHistorySaveLocation', JSON.stringify({
            latitude: location.coords.latitude,
            longitude: location.coords.longitude,
          }));
          
          console.log('[HeadlessTask] Location saved to locationHistory');
        } catch (historyError) {
          console.error('[HeadlessTask] Error saving to locationHistory:', historyError);
          // Don't throw - just log the error
        }
      } else {
        console.log('[HeadlessTask] Skipping locationHistory save (conditions not met)');
      }
      
    } catch (error) {
      console.error('[HeadlessTask] Error saving location:', error);
    }
  }
};

// Register the headless task
BackgroundGeolocation.registerHeadlessTask(HeadlessTask);

