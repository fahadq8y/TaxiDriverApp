# دليل نشر v2.2.7

**تاريخ الإصدار:** 30 أكتوبر 2025  
**Commit Hash:** fbd627b  
**Tag:** v2.2.7

---

## ✅ الخطوة 1: التحقق من GitHub

تم بنجاح:
- ✅ Commit: `fbd627b`
- ✅ Push to main branch
- ✅ Tag: `v2.2.7` created and pushed
- ✅ Repository: https://github.com/fahadq8y/TaxiDriverApp

---

## 🏗️ الخطوة 2: بناء APK على Codemagic

### الطريقة 1: Trigger Build من Dashboard
1. افتح Codemagic: https://codemagic.io/
2. اذهب إلى مشروع **TaxiDriverApp**
3. اضغط على **"Start new build"**
4. اختر branch: **main**
5. اختر workflow: **Android Workflow**
6. اضغط **"Start build"**

### الطريقة 2: Trigger Build من GitHub
- Codemagic قد يكون مُعد للبناء التلقائي عند push إلى main
- تحقق من Codemagic dashboard لرؤية إذا كان build قد بدأ تلقائياً

### ما يجب مراقبته أثناء البناء:
```
✅ Checkout code from GitHub
✅ Install dependencies (npm install)
✅ Build Android APK (./gradlew assembleRelease)
✅ Sign APK with keystore
✅ Upload artifacts
```

### معلومات البناء المتوقعة:
- **Build Number:** سيكون أعلى من #106 (آخر build ناجح)
- **Version Code:** 10
- **Version Name:** 2.2.7
- **Package:** com.dp.taxidriver
- **Output:** `app-release.apk`

---

## 📱 الخطوة 3: تحميل وتثبيت APK

### بعد اكتمال البناء:
1. اذهب إلى Codemagic build page
2. اضغط على **"Artifacts"**
3. حمّل `app-release.apk`
4. انقل الملف إلى جهاز الاختبار (Fahd - DRV002)

### تثبيت APK:
```bash
# عبر ADB (إذا كان الجهاز متصل بالكمبيوتر)
adb install -r app-release.apk

# أو
# انقل الملف إلى الجهاز وثبته يدوياً
```

### ملاحظات مهمة:
- ⚠️ يجب إلغاء تثبيت v2.2.6 أولاً (لأن versionCode تغير من 6 إلى 10)
- ⚠️ أو استخدم `adb install -r` للتحديث مباشرة
- ✅ تأكد من أن الجهاز يسمح بتثبيت التطبيقات من مصادر غير معروفة

---

## 🧪 الخطوة 4: الاختبار والتحقق

### 4.1 اختبار أولي (بعد التثبيت مباشرة)
```
✅ افتح التطبيق
✅ سجّل دخول بحساب Fahd (DRV002)
✅ تحقق من ظهور "v2.2.7" في الشاشة الرئيسية
✅ انتظر 5 ثواني
```

### 4.2 اختبار حفظ الموقع في Firestore
1. افتح Firebase Console: https://console.firebase.google.com/
2. اذهب إلى **Firestore Database**
3. افتح collection: `drivers`
4. افتح document: `DRV002`
5. **تحقق من وجود:**
   ```
   ✅ latitude: (رقم)
   ✅ longitude: (رقم)
   ✅ speed: (رقم)
   ✅ accuracy: (رقم)
   ✅ heading: (رقم)
   ✅ lastUpdate: (timestamp)
   ✅ isActive: true
   ```

### 4.3 اختبار FCM Token Registration
1. في نفس driver document (DRV002)
2. **تحقق من وجود:**
   ```
   ✅ fcmToken: "ey..." (string طويل)
   ✅ fcmTokenUpdatedAt: (timestamp)
   ```

### 4.4 اختبار Smart Stop Detection
**اختبار 1: السائق متوقف**
1. ضع الجهاز في مكان ثابت (لا يتحرك)
2. راقب `locationHistory` collection في Firestore
3. **المتوقع:** حفظ موقع جديد كل **5 دقائق** فقط

**اختبار 2: السائق يتحرك**
1. تحرك بالجهاز (امشِ أو اركب سيارة)
2. راقب `locationHistory` collection في Firestore
3. **المتوقع:** حفظ موقع جديد كل **دقيقة واحدة**

### 4.5 اختبار Background Tracking
1. اضغط Home button (التطبيق في background)
2. انتظر 5 دقائق
3. تحقق من Firestore - يجب أن يستمر حفظ الموقع
4. **المتوقع:** ✅ الموقع يُحفظ حتى في background

### 4.6 اختبار Force Stop + FCM Wake-up
1. اذهب إلى Settings → Apps → White Horse Taxi
2. اضغط **"Force Stop"**
3. انتظر دقيقة
4. أرسل FCM wake-up push notification من Firebase Console:
   ```json
   {
     "to": "<FCM_TOKEN_FROM_FIRESTORE>",
     "data": {
       "type": "wake_up",
       "driverId": "DRV002"
     }
   }
   ```
5. تحقق من Firestore - يجب أن يستأنف حفظ الموقع
6. **المتوقع:** ✅ التتبع يعود للعمل بعد Force Stop

---

## 📊 الخطوة 5: المراقبة المستمرة

### مراقبة Firestore
افتح Firebase Console وراقب:

**1. Driver Document (DRV002):**
```
✅ latitude, longitude يتحدثان باستمرار
✅ lastUpdate يتحدث كل 10 ثواني تقريباً
✅ speed يتغير حسب حركة السائق
✅ fcmToken موجود ولا يتغير (إلا عند إعادة تثبيت التطبيق)
```

**2. locationHistory Collection:**
```
✅ مواقع جديدة تُضاف كل دقيقة (عند الحركة)
✅ مواقع جديدة تُضاف كل 5 دقائق (عند التوقف)
✅ كل موقع يحتوي على: latitude, longitude, speed, accuracy, heading, timestamp
```

**3. tracking_events Collection (اختياري):**
```
✅ أحداث fcm_restart عند إرسال wake-up push
✅ success: true/false حسب نجاح إعادة التشغيل
```

### مراقبة Logcat (اختياري)
إذا كان الجهاز متصل بالكمبيوتر:
```bash
adb logcat | grep -E "LocationService|HeadlessTask|FCM"
```

**ما يجب رؤيته:**
```
✅ [LocationService] Location received: ...
✅ [LocationService] Location saved to Firestore
✅ [LocationService] Location saved to history
✅ [FCM] Token: ...
✅ [FCM] Token registered successfully
✅ [HeadlessTask] Location saved successfully
```

---

## ⚠️ استكشاف الأخطاء

### المشكلة: الموقع لا يُحفظ في Firestore
**الحل:**
1. تحقق من صلاحية الموقع (Location Permission)
2. تحقق من اتصال الإنترنت
3. راجع Logcat للأخطاء
4. تحقق من Firebase Rules

### المشكلة: FCM Token لا يظهر في Firestore
**الحل:**
1. انتظر 10 ثواني بعد فتح التطبيق
2. تحقق من Logcat: `[FCM] Token registered successfully`
3. تحقق من `registerFCMToken()` في MainScreen.js
4. تحقق من Firebase Rules للكتابة في drivers collection

### المشكلة: Smart Stop Detection لا يعمل
**الحل:**
1. تحقق من أن `speed` ليس null في Firestore
2. راجع Logcat: `[shouldSaveToHistory] Driver stopped/moving`
3. تحقق من التعديلات في `LocationService.js` و `index.js`

### المشكلة: التتبع يتوقف بعد Force Stop
**الحل:**
1. تحقق من FCM token في Firestore
2. أرسل wake-up push notification يدوياً
3. تحقق من Battery Optimization - يجب أن تكون disabled
4. راجع `messaging().setBackgroundMessageHandler` في index.js

---

## 📝 ملاحظات مهمة

### الفرق بين v2.2.6 و v2.2.7:
| الميزة | v2.2.6 | v2.2.7 |
|--------|--------|--------|
| حفظ الموقع في driver document | ❌ فقط lastUpdate | ✅ latitude, longitude, speed |
| Smart Stop Detection | ❌ يتعطل مع null speed | ✅ يعمل مع ?? operator |
| FCM Token Registration | ❌ لا يُسجل (timing issue) | ✅ يُسجل بعد driverId loads |
| Headless Task | ❌ نفس المشاكل | ✅ مُصلح |

### متى تعتبر v2.2.7 ناجحة؟
✅ **النجاح الكامل عندما:**
1. الموقع يُحفظ في driver document (latitude, longitude, speed)
2. FCM token يظهر في Firestore بعد تسجيل الدخول
3. Smart Stop Detection يعمل بدون أخطاء
4. التتبع يستمر 24/7 حتى بعد Force Stop
5. locationHistory يُحدث حسب Smart Stop Detection

---

## 🎯 الخطوات التالية بعد النجاح

### إذا نجح الاختبار على DRV002:
1. ✅ نشر v2.2.7 على باقي السائقين (DRV003, DRV004, DRV005)
2. ✅ مراقبة جميع السائقين لمدة 24 ساعة
3. ✅ التحقق من عدم وجود أخطاء في Logcat أو Firestore
4. ✅ إنشاء Release Notes رسمية
5. ✅ نشر على Production (إذا كان هناك نظام production منفصل)

### إذا فشل الاختبار:
1. ❌ راجع Logcat للأخطاء
2. ❌ راجع Firebase Console للبيانات المفقودة
3. ❌ راجع الكود في الملفات المُعدلة
4. ❌ أنشئ issue في GitHub مع تفاصيل الخطأ
5. ❌ عُد إلى v2.2.0 (branch: v2.2.0-working) إذا لزم الأمر

---

## 📞 الدعم

إذا واجهت أي مشاكل:
1. راجع Logcat: `adb logcat | grep -E "LocationService|FCM|HeadlessTask"`
2. راجع Firebase Console: https://console.firebase.google.com/
3. راجع GitHub Issues: https://github.com/fahadq8y/TaxiDriverApp/issues
4. راجع ملفات التوثيق:
   - `V2.2.7_FIXES_SUMMARY.md`
   - `V2.2.7_FIX_PLAN.md`
   - `CODE_ANALYSIS_REPORT.md`

---

**تم إنشاء هذا الدليل بواسطة:** Manus AI  
**التاريخ:** 30 أكتوبر 2025  
**الإصدار:** v2.2.7

